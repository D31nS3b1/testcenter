<!--    <pre>{{booklet$|async|json}}</pre>-->
<div *ngIf="(booklet$ | async) as booklet; else: noBooklet">

    <div class="booklet">

        <h1>{{booklet.metadata.label}}</h1>

        <div *ngIf="booklet.units as testlet" class="units">

            <ng-container *ngTemplateOutlet="testletTemplate; context: {$implicit: testlet}"></ng-container>
        </div>
    </div>

</div>

<!--    <pre>{{featuredUnit$|async|json}}</pre>-->

<div class="featured-unit" *ngIf="featuredUnit$ | async as unitContext">


    <h1>{{unitContext.parent.label || 'Aktueller Abschnitt'}}</h1>

    <mat-icon class="unit-badge"
              *ngIf="maxTimeLeft && (maxTimeLeft[unitContext.parent.id] !== undefined)"
              matBadge="{{maxTimeLeft[unitContext.parent.id].toString()}}"
              matBadgeColor="accent"
              matTooltip="Verbleibende Zeit"
        >alarm
    </mat-icon>

    <h1>:</h1>

    <h2>{{unitContext.unit.label || unitContext.unit.labelShort || unitContext.unit.id}}</h2>

    <mat-icon class="unit-badge"
              *ngIf="hasState(testStatus.unitState, 'PRESENTATIONCOMPLETE', 'yes')"
              matTooltip="Vollständig betrachtet / angehört"
        >remove_red_eye
    </mat-icon>

    <mat-icon class="unit-badge"
              *ngIf="hasState(testStatus.unitState, 'RESPONSESCOMPLETE', 'all')"
              matTooltip="Fertig beantwortet"
        >done_all
    </mat-icon>

    <!--                <div class="state"><pre>{{testStatus.unitState | json}}</pre></div>-->
    <!--                <div class="state"><pre>{{testStatus.testState | json}}</pre></div>-->
    <!--                <div class="state"><pre>{{unit | json}}</pre></div>-->
</div>

<!--<pre>{{maxTimeLeft|json}}</pre>-->


<ng-template #testletTemplate let-testlet>

    <ng-container *ngFor="let testletOrUnit of testlet.children; trackBy: trackUnits" [ngSwitch]="getTestletType(testletOrUnit)">

        <span *ngSwitchCase="'unit'"
              class="{{(testStatus.unitName === testletOrUnit.id) ? 'unit current': 'unit'}}"
              matTooltip="{{testletOrUnit.label}}"
              matTooltipPosition="above"
            >{{testletOrUnit.labelShort || "&nbsp;"}}
        </span>

        <span *ngSwitchCase="'testlet'" class="testlet" matTooltip="{{testletOrUnit.label}}">
            <ng-container *ngTemplateOutlet="testletTemplate; context: {$implicit: testletOrUnit}"></ng-container>
        </span>
        <!--                <pre>{{testletOrUnit|json}}</pre>-->

    </ng-container>
</ng-template>


<ng-template #noBooklet>
    <div class="booklet">
        <h1>Noch kein Test gestarted.</h1>
    </div>
</ng-template>
