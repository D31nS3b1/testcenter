<td>
    <div class="vertical-align-middle">
        <ng-container *ngIf="getMode(testStatus.mode) as mode" >

            <mat-icon *ngIf="mode.modeId === 'HOT'">face</mat-icon>
            <mat-icon *ngIf="mode.modeId === 'REVIEW'">rate_review</mat-icon>
            <mat-icon *ngIf="mode.modeId === 'TRIAL'">remove_red_eye</mat-icon>
            <mat-icon *ngIf="mode.modeId === 'DEMO'">ondemand_video</mat-icon>
            <mat-icon *ngIf="mode.modeId === 'monitor-group'">supervisor_account</mat-icon>
            <mat-icon *ngIf="mode.modeId === 'monitor-workspace'">supervisor_account</mat-icon>
            <mat-icon *ngIf="mode.modeId === 'monitor-study'">supervisor_account</mat-icon>
        </ng-container>
        <h1>{{testStatus.personLabel}}</h1>
    </div>
</td>


<td *ngIf="displayOptions.groupColumn === 'show'"><div class="vertical-align-middle">{{testStatus.groupLabel}}</div></td>


<ng-container *ngIf="(booklet$ | async) as booklet">

    <ng-container *ngIf="isBooklet(booklet); else: noBooklet">

        <td class="booklet" >

            <div class="vertical-align-middle">

                <h1>{{booklet.metadata.label}}</h1>

                <mat-icon class="unit-badge"
                          *ngIf="hasState(testStatus.testState, 'status', 'locked')"
                          matTooltip="Testheft gesperrt"
                    >lock
                </mat-icon>

                <mat-icon class="unit-badge"
                          *ngIf="!hasState(testStatus.testState, 'status', 'locked')"
                          matTooltip="Testheft gesperrt"
                    >lock_open
                </mat-icon>

                <mat-icon class="unit-badge"
                          *ngIf="hasState(testStatus.testState, 'BOOKLETLOCKEDbyTESTEE')"
                          matTooltip="Testheft abgeschlossen"
                    >done_all
                </mat-icon>
            </div>
        </td>

        <td *ngIf="booklet.units as testlet">

            <div
                    class="units-container"
                    [class]="hasState(testStatus.testState, 'status', 'locked') ? 'locked' : ''"
                    [ngSwitch]="displayOptions.view"
                >
                    <div class="units full" *ngSwitchCase="'full'" >
                        <ng-container *ngTemplateOutlet="testletTemplate; context: {$implicit: testlet}">
                        </ng-container>
                    </div>

                    <div class="units medium" *ngSwitchCase="'medium'" >
                        <ng-container *ngTemplateOutlet="bookletTemplateMedium; context: {$implicit: testlet}">
                        </ng-container>
                    </div>

                    <div class="units small" *ngSwitchCase="'small'" >
                        <ng-container *ngTemplateOutlet="testletBookletSmall; context: {$implicit: testlet}">
                        </ng-container>
                    </div>
            </div>

            <ng-container *ngIf="displayOptions.view === 'full'">
                <ng-container *ngTemplateOutlet="featuredUnit"></ng-container>
            </ng-container>

        </td>
    </ng-container>

    <ng-template #noBooklet>
        <td colspan="2" class="booklet">
            <span *ngIf="booklet.error == 'missing-id'">Kein Testheft zugeordnet</span>
            <span *ngIf="booklet.error == 'missing-file'" class="warning">
                Kein Zugriff auf Testheft-Datei (`{{testStatus.bookletName}}`)!
            </span>
            <span *ngIf="booklet.error == 'xml'" class="warning">
                Konnte Testheft-Datei (`{{testStatus.bookletName}}`) lesen!
            </span>
            <span *ngIf="booklet.error == 'general'" class="warning">>
                Fehler beim Zugriff aus Testheft-Datei (`{{testStatus.bookletName}}`)!
            </span>
        </td>
    </ng-template>
</ng-container>


<ng-template #featuredUnit>

    <div class="featured-unit" *ngIf="(featuredUnit$| async) as unitContext; else: noFeaturedUnit">

        <h1>{{unitContext.parent.label || 'Aktueller Abschnitt'}}</h1>

        <mat-icon class="unit-badge"
                  *ngIf="maxTimeLeft && (maxTimeLeft[unitContext.parent.id] !== undefined)"
                  matBadge="{{maxTimeLeft[unitContext.parent.id].toString()}}"
                  matBadgeColor="accent"
                  matTooltip="Verbleibende Zeit"
        >alarm
        </mat-icon>

        <h1>:</h1>

        <h2>{{unitContext.unit.label || unitContext.unit.labelShort || unitContext.unit.id}}</h2>

        <mat-icon class="unit-badge"
                  *ngIf="hasState(testStatus.unitState, 'PRESENTATIONCOMPLETE', 'yes')"
                  matTooltip="Vollständig betrachtet / angehört"
        >remove_red_eye
        </mat-icon>

        <mat-icon class="unit-badge"
                  *ngIf="hasState(testStatus.unitState, 'RESPONSESCOMPLETE', 'all')"
                  matTooltip="Fertig beantwortet"
        >done_all
        </mat-icon>
    </div>
</ng-template>


<ng-template #noFeaturedUnit>
</ng-template>


<ng-template #testletTemplate let-testlet>

    <span *ngIf="testlet.restrictions && testlet.restrictions.codeToEnter as codeToEnter"
          class="unit restriction"
          matTooltip="Freigabewort: {{codeToEnter.code.toUpperCase()}}"
          matTooltipPosition="above"
        >
        <mat-icon>sms</mat-icon>
    </span>

    <span *ngIf="testlet.restrictions && testlet.restrictions.lock as lock"
          class="unit restriction"
          matTooltip="{{lock.message}}"
          matTooltipPosition="above"
        >
        <mat-icon>lock</mat-icon>
    </span>

    <ng-container *ngFor="let testletOrUnit of testlet.children; trackBy: trackUnits" [ngSwitch]="getTestletType(testletOrUnit)">

        <span *ngSwitchCase="'unit'"
              [class]="(testStatus.unitName === testletOrUnit.id) ? 'unit current': 'unit'"
              matTooltip="{{testletOrUnit.label}}"
              matTooltipPosition="above"
        >{{testletOrUnit.labelShort || "&nbsp;"}}
        </span>

        <span *ngSwitchCase="'testlet'" class="testlet" matTooltip="{{testletOrUnit.label}}">
            <ng-container *ngTemplateOutlet="testletTemplate; context: {$implicit: testletOrUnit}"></ng-container>
        </span>

    </ng-container>

</ng-template>


<ng-template #bookletTemplateMedium let-testlet>

    <ng-container *ngIf="featuredUnit$ | async as featuredUnit; else: nonFeaturedTestlet">
        <ng-container *ngTemplateOutlet="testletTemplateMedium; context: {testlet: testlet, featuredUnit: featuredUnit}">
        </ng-container>
    </ng-container>

    <ng-template #nonFeaturedTestlet>
        <ng-container *ngTemplateOutlet="testletTemplateMedium; context: {testlet: testlet, featuredUnit: false}">
        </ng-container>
    </ng-template>
</ng-template>


<ng-template #testletTemplateMedium let-testlet="testlet" let-featuredUnit="featuredUnit">

    <ng-container *ngFor="let testletOrUnit of testlet.children; let i = index; trackBy: trackUnits" [ngSwitch]="getTestletType(testletOrUnit)">

        <span *ngSwitchCase="'unit'"
              [class]="(testStatus.unitName === testletOrUnit.id) ? 'unit current': 'unit'"
              matTooltip="{{testletOrUnit.label}}"
              matTooltipPosition="above"
        >·
        </span>

        <span *ngSwitchCase="'testlet'" class="testlet" matTooltip="{{testletOrUnit.label}}">

            <ng-container *ngIf="featuredUnit; else: unFeaturedTestlet">
                <span
                        *ngIf="featuredUnit.ancestor.id === testletOrUnit.id; else: unFeaturedTestlet"
                        class="unit current aggregated"
                        matTooltip="{{featuredUnit.unit.label}}"
                        matTooltipPosition="above"
                >{{featuredUnit.indexAncestor + 1}} / {{featuredUnit.unitCountAncestor}}
                </span>
            </ng-container>

            <ng-template #unFeaturedTestlet>
                <span class="unit aggregated">{{testletOrUnit.descendantCount}}</span>
            </ng-template>
        </span>
    </ng-container>
</ng-template>


<ng-template #testletBookletSmall let-testlet>

    <span
            class="testlet" *ngIf="featuredUnit$ | async as featuredUnit; else: nonFeaturedTestlet"
            matTooltip="{{featuredUnit.parent.label}}"
        >
        <span
                class="unit current aggregated"
                matTooltip="{{featuredUnit.unit.label}}"
                matTooltipPosition="above"
            >
            {{featuredUnit.indexGlobal + 1}} / {{featuredUnit.unitCountGlobal}}
        </span>
    </span>

    <ng-template #nonFeaturedTestlet>
        <span class="testlet" >
            <span class="unit aggregated">{{testlet.descendantCount}}</span>
        </span>
    </ng-template>
</ng-template>



